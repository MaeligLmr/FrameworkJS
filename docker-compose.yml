
services:
  mongo:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-adminpassword}
      - MONGO_INITDB_DATABASE=${MONGO_INITDB_DATABASE:-blog_mern}
    volumes:
      - db_data:/data/db
    ports:
      - "27017:27017"

  backend:
    image: node:20-alpine
    container_name: backend
    restart: unless-stopped
    working_dir: /usr/src/app
    volumes:
      - ./backend:/usr/src/app
    command: sh -c "npm install && npm run dev"
    env_file:
      - .env
    environment:
      - PORT=${PORT:-3000}
      - ENVIRONNEMENT=${ENVIRONNEMENT:-development}
      - MONGO_DB_URI=${MONGO_DB_URI:-mongodb://admin:adminpassword@mongo:27017/blog_mern?authSource=admin}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-1d}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000,http://frontend:5173}
      - CLOUD_CLOUD_NAME=${CLOUD_CLOUD_NAME}
      - CLOUD_API_KEY=${CLOUD_API_KEY}
      - CLOUD_API_SECRET=${CLOUD_API_SECRET}
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Blog App}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
    ports:
      - "3000:3000"
    depends_on:
      - mongo

  frontend:
    image: node:20-alpine
    container_name: frontend
    restart: unless-stopped
    working_dir: /usr/src/app
    volumes:
      - ./frontend:/usr/src/app
    command: sh -c "npm install && npm run dev"
    env_file:
      - .env
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:3000/api}
    ports:
      - "5173:5173"
    depends_on:
      - backend

volumes:
  db_data:
